#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "textual>=0.47.1",
# ]
# ///

"""
Dotfiles Setup TUI
==================
Interactive TUI for setting up and configuring dotfiles on a new desktop.
"""

import os
import subprocess
import sys
from pathlib import Path
from typing import List, Dict, Tuple

from textual import on, work
from textual.app import App, ComposeResult
from textual.containers import Container, Horizontal, Vertical, VerticalScroll
from textual.widgets import (
    Button,
    Checkbox,
    Footer,
    Header,
    Label,
    ListItem,
    ListView,
    Static,
    TabbedContent,
    TabPane,
    TextLog,
)
from textual.worker import Worker, WorkerState


class StatusMessage(Static):
    """Widget to display status messages with color coding."""

    def set_status(self, message: str, status: str = "info"):
        """Set status message with appropriate styling."""
        if status == "success":
            self.update(f"[green]✓[/green] {message}")
        elif status == "error":
            self.update(f"[red]✗[/red] {message}")
        elif status == "warning":
            self.update(f"[yellow]![/yellow] {message}")
        else:
            self.update(f"[blue]ℹ[/blue] {message}")


class SetupSection(Static):
    """A section for a specific setup component."""

    DEFAULT_CSS = """
    SetupSection {
        height: auto;
        margin: 1;
        padding: 1;
        border: solid $primary;
    }
    
    SetupSection Label {
        margin: 0 0 1 0;
    }
    
    SetupSection Checkbox {
        margin: 0 0 0 2;
    }
    """

    def __init__(
        self,
        title: str,
        description: str,
        items: List[Tuple[str, str]],
        *args,
        **kwargs,
    ):
        super().__init__(*args, **kwargs)
        self.title = title
        self.description = description
        self.items = items  # List of (name, script_path) tuples

    def compose(self) -> ComposeResult:
        yield Label(f"[bold]{self.title}[/bold]")
        yield Label(f"[dim]{self.description}[/dim]")
        for name, script_path in self.items:
            yield Checkbox(name, value=True, id=f"check_{script_path}")


class LogViewer(VerticalScroll):
    """Widget to display command output logs."""

    DEFAULT_CSS = """
    LogViewer {
        height: 100%;
        border: solid $secondary;
        padding: 1;
    }
    
    LogViewer TextLog {
        height: 100%;
    }
    """

    def compose(self) -> ComposeResult:
        yield TextLog(highlight=True, markup=True)

    def write_line(self, message: str, style: str = ""):
        """Write a line to the log."""
        text_log = self.query_one(TextLog)
        if style:
            text_log.write(f"[{style}]{message}[/{style}]")
        else:
            text_log.write(message)

    def clear_log(self):
        """Clear the log."""
        text_log = self.query_one(TextLog)
        text_log.clear()


class DotfilesSetupApp(App):
    """A Textual app for setting up dotfiles."""

    CSS = """
    Screen {
        align: center middle;
    }
    
    #main-container {
        width: 90%;
        height: 90%;
        border: thick $background 50%;
        background: $surface;
    }
    
    #button-container {
        height: auto;
        width: 100%;
        align: center middle;
        padding: 1;
    }
    
    #button-container Button {
        margin: 0 1;
    }
    
    #status-bar {
        dock: bottom;
        height: 3;
        background: $panel;
        padding: 1;
    }
    """

    BINDINGS = [
        ("q", "quit", "Quit"),
        ("d", "toggle_dark", "Toggle Dark Mode"),
    ]

    def __init__(self):
        super().__init__()
        self.dotfiles_path = Path.home() / "dotfiles"
        self.setup_items: Dict[str, List[Tuple[str, str]]] = {}
        self._scan_setup_items()

    def _scan_setup_items(self):
        """Scan the repository for available setup items."""
        apps_dir = self.dotfiles_path / "applications"
        if apps_dir.exists():
            install_scripts = []
            for script in sorted(apps_dir.glob("install-*.sh")):
                name = script.stem.replace("install-", "").replace("-", " ").title()
                install_scripts.append((name, str(script.relative_to(self.dotfiles_path))))
            
            if install_scripts:
                self.setup_items["applications"] = install_scripts

        # Stow packages (directories with config files)
        stow_dirs = []
        for item in sorted(self.dotfiles_path.iterdir()):
            if item.is_dir() and not item.name.startswith(".") and item.name not in [
                "applications",
                "vscode",
                "prompts",
            ]:
                stow_dirs.append((item.name.title(), item.name))
        
        if stow_dirs:
            self.setup_items["stow_packages"] = stow_dirs

    def compose(self) -> ComposeResult:
        """Create child widgets for the app."""
        yield Header(show_clock=True)
        
        with Container(id="main-container"):
            with TabbedContent(initial="overview"):
                with TabPane("Overview", id="overview"):
                    yield Static(
                        "[bold]Dotfiles Setup Tool[/bold]\n\n"
                        "This interactive tool will help you set up your dotfiles "
                        "and install applications on a new system.\n\n"
                        "[dim]Use the tabs above to navigate between sections.[/dim]",
                        id="welcome",
                    )
                    yield Static(
                        f"\n[bold]Repository:[/bold] {self.dotfiles_path}\n"
                        f"[bold]Home:[/bold] {Path.home()}\n"
                        f"[bold]User:[/bold] {os.getenv('USER', 'unknown')}",
                        id="system-info",
                    )
                
                with TabPane("Prerequisites", id="prereqs"):
                    yield Label("[bold]System Prerequisites[/bold]\n")
                    yield Label("The following tools are required:")
                    yield Checkbox("Git", value=True, id="check_git", disabled=True)
                    yield Checkbox("Stow", value=False, id="check_stow")
                    yield Checkbox("Curl", value=False, id="check_curl")
                    yield Label("\n[dim]Click 'Check Prerequisites' to verify installations.[/dim]")
                
                with TabPane("Stow Packages", id="stow"):
                    with VerticalScroll():
                        if "stow_packages" in self.setup_items:
                            yield SetupSection(
                                "Configuration Packages",
                                "Select which configuration packages to stow to $HOME",
                                self.setup_items["stow_packages"],
                            )
                        else:
                            yield Label("[yellow]No stow packages found[/yellow]")
                
                with TabPane("Applications", id="apps"):
                    with VerticalScroll():
                        if "applications" in self.setup_items:
                            yield SetupSection(
                                "Application Installers",
                                "Select which applications to install",
                                self.setup_items["applications"],
                            )
                        else:
                            yield Label("[yellow]No application installers found[/yellow]")
                
                with TabPane("Execution Log", id="log"):
                    yield LogViewer()
            
            with Horizontal(id="button-container"):
                yield Button("Check Prerequisites", id="btn_check", variant="primary")
                yield Button("Run Setup", id="btn_setup", variant="success")
                yield Button("Stow All", id="btn_stow", variant="default")
                yield Button("Clear Log", id="btn_clear", variant="default")
        
        with Container(id="status-bar"):
            yield StatusMessage("Ready to configure your dotfiles")
        
        yield Footer()

    def on_mount(self) -> None:
        """Called when app starts."""
        self.title = "Dotfiles Setup"
        self.sub_title = str(self.dotfiles_path)
        self._check_prerequisites_silent()

    def _check_prerequisites_silent(self):
        """Silently check prerequisites on startup."""
        try:
            subprocess.run(["git", "--version"], capture_output=True, check=True)
        except (subprocess.CalledProcessError, FileNotFoundError):
            pass
        
        try:
            subprocess.run(["stow", "--version"], capture_output=True, check=True)
            self.query_one("#check_stow", Checkbox).value = True
        except (subprocess.CalledProcessError, FileNotFoundError):
            pass
        
        try:
            subprocess.run(["curl", "--version"], capture_output=True, check=True)
            self.query_one("#check_curl", Checkbox).value = True
        except (subprocess.CalledProcessError, FileNotFoundError):
            pass

    @on(Button.Pressed, "#btn_check")
    def check_prerequisites(self):
        """Check if required tools are installed."""
        self._update_status("Checking prerequisites...", "info")
        log = self.query_one(LogViewer)
        log.clear_log()
        log.write_line("=== Checking Prerequisites ===\n", "bold cyan")
        
        tools = [("git", "#check_git"), ("stow", "#check_stow"), ("curl", "#check_curl")]
        all_good = True
        
        for tool, checkbox_id in tools:
            try:
                result = subprocess.run(
                    [tool, "--version"],
                    capture_output=True,
                    text=True,
                    check=True,
                )
                self.query_one(checkbox_id, Checkbox).value = True
                log.write_line(f"✓ {tool}: Found", "green")
                log.write_line(f"  {result.stdout.splitlines()[0]}", "dim")
            except (subprocess.CalledProcessError, FileNotFoundError):
                self.query_one(checkbox_id, Checkbox).value = False
                log.write_line(f"✗ {tool}: Not found", "red")
                all_good = False
        
        if all_good:
            self._update_status("All prerequisites satisfied!", "success")
        else:
            self._update_status("Some prerequisites are missing", "warning")

    @on(Button.Pressed, "#btn_setup")
    @work(exclusive=True)
    async def run_setup(self):
        """Run the selected setup items."""
        log = self.query_one(LogViewer)
        log.clear_log()
        log.write_line("=== Starting Setup ===\n", "bold cyan")
        
        self._update_status("Running setup...", "info")
        
        # Check stow is available
        stow_check = self.query_one("#check_stow", Checkbox)
        if not stow_check.value:
            log.write_line("✗ Stow is not installed. Cannot proceed.", "red")
            self._update_status("Setup failed: stow not found", "error")
            return
        
        # Run application installers
        if "applications" in self.setup_items:
            log.write_line("\n--- Installing Applications ---\n", "bold yellow")
            for name, script_path in self.setup_items["applications"]:
                checkbox = self.query_one(f"#check_{script_path}", Checkbox)
                if checkbox.value:
                    await self._run_script(script_path, name, log)
        
        # Stow selected packages
        if "stow_packages" in self.setup_items:
            log.write_line("\n--- Stowing Configuration Packages ---\n", "bold yellow")
            for name, package in self.setup_items["stow_packages"]:
                checkbox = self.query_one(f"#check_{package}", Checkbox)
                if checkbox.value:
                    await self._stow_package(package, log)
        
        log.write_line("\n=== Setup Complete ===", "bold green")
        self._update_status("Setup completed!", "success")

    async def _run_script(self, script_path: str, name: str, log: LogViewer):
        """Run an installation script."""
        full_path = self.dotfiles_path / script_path
        log.write_line(f"\n▶ Running: {name}", "cyan")
        log.write_line(f"  Script: {script_path}", "dim")
        
        try:
            process = await self.run_process(
                f"bash {full_path}",
                shell=True,
                cwd=str(self.dotfiles_path),
            )
            
            if process.returncode == 0:
                log.write_line(f"✓ {name} completed successfully", "green")
            else:
                log.write_line(f"✗ {name} failed (exit code: {process.returncode})", "red")
                if process.stderr:
                    log.write_line(f"  Error: {process.stderr}", "red")
        except Exception as e:
            log.write_line(f"✗ {name} failed: {str(e)}", "red")

    async def _stow_package(self, package: str, log: LogViewer):
        """Stow a configuration package."""
        log.write_line(f"\n▶ Stowing: {package}", "cyan")
        
        try:
            process = await self.run_process(
                f"stow --verbose --restow --target={Path.home()} {package}",
                shell=True,
                cwd=str(self.dotfiles_path),
            )
            
            if process.returncode == 0:
                log.write_line(f"✓ {package} stowed successfully", "green")
            else:
                log.write_line(f"✗ {package} stow failed (exit code: {process.returncode})", "red")
                if process.stderr:
                    log.write_line(f"  Error: {process.stderr}", "red")
        except Exception as e:
            log.write_line(f"✗ {package} stow failed: {str(e)}", "red")

    @on(Button.Pressed, "#btn_stow")
    @work(exclusive=True)
    async def stow_all(self):
        """Stow all packages at once."""
        log = self.query_one(LogViewer)
        log.clear_log()
        log.write_line("=== Stowing All Packages ===\n", "bold cyan")
        
        self._update_status("Stowing all packages...", "info")
        
        try:
            process = await self.run_process(
                f"stow --verbose --restow --target={Path.home()} */",
                shell=True,
                cwd=str(self.dotfiles_path),
            )
            
            if process.returncode == 0:
                log.write_line("✓ All packages stowed successfully", "green")
                self._update_status("All packages stowed!", "success")
            else:
                log.write_line(f"✗ Stow failed (exit code: {process.returncode})", "red")
                if process.stderr:
                    log.write_line(f"Error: {process.stderr}", "red")
                self._update_status("Stow failed", "error")
        except Exception as e:
            log.write_line(f"✗ Stow failed: {str(e)}", "red")
            self._update_status("Stow failed", "error")

    @on(Button.Pressed, "#btn_clear")
    def clear_log(self):
        """Clear the execution log."""
        log = self.query_one(LogViewer)
        log.clear_log()
        self._update_status("Log cleared", "info")

    def _update_status(self, message: str, status: str = "info"):
        """Update the status bar."""
        status_widget = self.query_one(StatusMessage)
        status_widget.set_status(message, status)

    async def run_process(self, command: str, shell: bool = True, cwd: str = None):
        """Run a subprocess asynchronously."""
        process = await subprocess.create_subprocess_shell(
            command,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            cwd=cwd,
        )
        stdout, stderr = await process.communicate()
        
        class Result:
            def __init__(self, returncode, stdout, stderr):
                self.returncode = returncode
                self.stdout = stdout.decode() if stdout else ""
                self.stderr = stderr.decode() if stderr else ""
        
        return Result(process.returncode, stdout, stderr)

    def action_toggle_dark(self) -> None:
        """Toggle dark mode."""
        self.dark = not self.dark


def main():
    """Main entry point."""
    # Check if we're in a dotfiles repository
    dotfiles_path = Path.home() / "dotfiles"
    
    if not dotfiles_path.exists():
        print("Error: Dotfiles directory not found at ~/dotfiles")
        print("\nPlease clone your dotfiles repository first:")
        print("  git clone https://github.com/rogvid/dotfiles.git ~/dotfiles")
        sys.exit(1)
    
    app = DotfilesSetupApp()
    app.run()


if __name__ == "__main__":
    main()

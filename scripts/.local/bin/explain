#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "einops>=0.8.1",
#     "pillow",
#     "requests",
#     "timm>=1.0.15",
#     "torch>=2.7.0",
#     "transformers",
# ]
# ///


import requests
import torch

device = "cuda:0" if torch.cuda.is_available() else "cpu"
torch_dtype = torch.float16 if torch.cuda.is_available() else torch.float32
from PIL import Image


def run_example(image, task_prompt, text_input=None):
    from transformers import AutoProcessor, AutoModelForCausalLM 
    model = AutoModelForCausalLM.from_pretrained("microsoft/Florence-2-base", trust_remote_code=True).to("cpu")
    processor = AutoProcessor.from_pretrained("microsoft/Florence-2-base", trust_remote_code=True)

    if text_input is None:
        prompt = task_prompt
    else:
        prompt = task_prompt + text_input
    inputs = processor(text=prompt, images=image, return_tensors="pt").to(device, torch_dtype)
    generated_ids = model.generate(
      input_ids=inputs["input_ids"],
      pixel_values=inputs["pixel_values"],
      max_new_tokens=1024,
      num_beams=3
    )
    generated_text = processor.batch_decode(generated_ids, skip_special_tokens=False)[0]

    parsed_answer = processor.post_process_generation(generated_text, task=task_prompt, image_size=(image.width, image.height))

    print(parsed_answer)

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(
        description="Simple image captioning with Florence2."
    )
    parser.add_argument(
        "input",
        help="List available input devices and exit",
    )
    parser.add_argument("-p", "--prompt", default="<CAPTION>", help="Base task")
    parser.add_argument("-t", "--text", default=None, help="Extra prompt")
    parser.add_argument("--list", action="store_true")

    args = parser.parse_args()

    if args.list:
        print("""
        <CAPTION> - Simple caption
        <DETAILED_CAPTION> - Caption with more details
        <MORE_DETAILED_CAPTION> - Caption with most details
        <OD> - Object detection returns bounding boxes
        <REGION_PROPOSAL> - Returns region proposals in json
        <OCR> - Optical character recognition
        """)

    if "http" in args.input:
        image = Image.open(requests.get(args.input, stream=True).raw)
    else:
        image = Image.open(args.input)

    print(args.prompt, args.text)
    run_example(
        image, args.prompt, args.text
    )

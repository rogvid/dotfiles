#!/usr/bin/env bash
set -euo pipefail

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=git-wt-common.sh
source "${SCRIPT_DIR}/git-wt-common.sh"

# Usage information
usage() {
  cat <<EOF
Usage: git-wt-list [OPTIONS]

List all worktrees for the current repository with merge status.

OPTIONS:
  -v, --verbose   Show verbose output (commit hashes)
  -h, --help      Show this help message

OUTPUT:
  ✓ = Branch merged into main
  • = Branch active (not merged)

EXAMPLES:
  git-wt-list           # List all worktrees
  git-wt-list -v        # List with commit information
EOF
  exit 0
}

# Parse command line arguments
VERBOSE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      ;;
    -v|--verbose)
      VERBOSE=true
      shift
      ;;
    -*)
      error "Unknown option: $1"
      usage
      ;;
    *)
      error "Unexpected argument: $1"
      usage
      ;;
  esac
done

# Validate environment
validate_in_git_repo

# Get repository information
REPO_ROOT="$(get_repo_root)"
REPO_NAME="$(get_repo_name)"
MAIN_BRANCH="$(get_main_branch)"

# Get current branch
CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")"

# Print header
echo -e "${COLOR_BOLD}Main repository:${COLOR_RESET} ${REPO_ROOT}"
echo -e "${COLOR_BOLD}Current branch:${COLOR_RESET} ${CURRENT_BRANCH}"
echo ""

# Parse worktree list
declare -a WORKTREES_DATA=()
CURRENT_WT=""
CURRENT_BRANCH_WT=""
CURRENT_COMMIT=""
IS_MAIN_REPO=false

while IFS= read -r line; do
  if [[ "${line}" =~ ^worktree\ (.+)$ ]]; then
    # Save previous worktree if it's not the main repo
    if [[ -n "${CURRENT_WT}" ]] && [[ "${IS_MAIN_REPO}" == false ]] && [[ "${CURRENT_WT}" != "${REPO_ROOT}" ]]; then
      WORKTREES_DATA+=("${CURRENT_WT}|${CURRENT_BRANCH_WT}|${CURRENT_COMMIT}")
    fi
    
    # Start new worktree
    CURRENT_WT="${BASH_REMATCH[1]}"
    CURRENT_BRANCH_WT=""
    CURRENT_COMMIT=""
    IS_MAIN_REPO=false
    
  elif [[ "${line}" =~ ^HEAD\ ([a-f0-9]+)$ ]]; then
    CURRENT_COMMIT="${BASH_REMATCH[1]}"
    
  elif [[ "${line}" =~ ^branch\ refs/heads/(.+)$ ]]; then
    CURRENT_BRANCH_WT="${BASH_REMATCH[1]}"
    
  elif [[ "${line}" =~ ^bare$ ]]; then
    IS_MAIN_REPO=true
    
  elif [[ "${line}" == "" ]]; then
    # Empty line, might be end of entry
    continue
  fi
done < <(git worktree list --porcelain)

# Save last worktree if it's not the main repo
if [[ -n "${CURRENT_WT}" ]] && [[ "${IS_MAIN_REPO}" == false ]] && [[ "${CURRENT_WT}" != "${REPO_ROOT}" ]]; then
  WORKTREES_DATA+=("${CURRENT_WT}|${CURRENT_BRANCH_WT}|${CURRENT_COMMIT}")
fi

# Check if there are any worktrees
if [[ ${#WORKTREES_DATA[@]} -eq 0 ]]; then
  echo "No worktrees found."
  echo ""
  echo "Create one with:"
  echo "  git-wt-add <branch-name>"
  exit 0
fi

# Print worktrees
echo -e "${COLOR_BOLD}Worktrees:${COLOR_RESET}"

for entry in "${WORKTREES_DATA[@]}"; do
  IFS='|' read -r wt_path wt_branch wt_commit <<< "${entry}"
  
  # Check if branch is merged
  MERGE_STATUS=""
  SYMBOL=""
  if is_branch_merged "${wt_branch}"; then
    MERGE_STATUS="${COLOR_GREEN}[MERGED]${COLOR_RESET}"
    SYMBOL="${COLOR_GREEN}✓${COLOR_RESET}"
  else
    MERGE_STATUS="${COLOR_BLUE}[ACTIVE]${COLOR_RESET}"
    SYMBOL="${COLOR_BLUE}•${COLOR_RESET}"
  fi
  
  # Get worktree name (basename of path)
  wt_name="$(basename "${wt_path}")"
  
  # Print worktree info
  if [[ "${VERBOSE}" == true ]]; then
    printf "  %b %-35s %-25s %b %-10s %b\n" \
      "${SYMBOL}" \
      "${wt_name}" \
      "${wt_branch}" \
      "${MERGE_STATUS}" \
      "${wt_commit:0:8}" \
      "${COLOR_DIM}${wt_path}${COLOR_RESET}"
  else
    printf "  %b %-35s %-25s %b %b\n" \
      "${SYMBOL}" \
      "${wt_name}" \
      "${wt_branch}" \
      "${MERGE_STATUS}" \
      "${COLOR_DIM}${wt_path}${COLOR_RESET}"
  fi
done

echo ""
echo "Legend:"
echo -e "  ${COLOR_GREEN}✓${COLOR_RESET} = Merged into ${MAIN_BRANCH}"
echo -e "  ${COLOR_BLUE}•${COLOR_RESET} = Active (not merged)"

#!/usr/bin/env bash
set -euo pipefail

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=git-wt-common.sh
source "${SCRIPT_DIR}/git-wt-common.sh"

# Usage information
usage() {
  cat <<EOF
Usage: git-wt-remove [OPTIONS] [branch-name|path]

Remove a git worktree interactively or by specifying branch name or path.

OPTIONS:
  -f, --force     Force removal without confirmation
  -d, --delete    Also delete the branch if it's merged
  -h, --help      Show this help message

EXAMPLES:
  git-wt-remove                    # Interactive selection with fzf
  git-wt-remove feat/old-feature   # Remove by branch name
  git-wt-remove ~/path/to/wt       # Remove by path
  git-wt-remove -f -d feat/done    # Force remove and delete merged branch
EOF
  exit 0
}

# Parse command line arguments
FORCE=false
DELETE_BRANCH=false
TARGET=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      ;;
    -f|--force)
      FORCE=true
      shift
      ;;
    -d|--delete)
      DELETE_BRANCH=true
      shift
      ;;
    -*)
      error "Unknown option: $1"
      usage
      ;;
    *)
      if [[ -z "${TARGET}" ]]; then
        TARGET="$1"
      else
        error "Too many arguments"
        usage
      fi
      shift
      ;;
  esac
done

# Validate environment
validate_in_git_repo

# Get repository information
REPO_ROOT="$(get_repo_root)"
MAIN_BRANCH="$(get_main_branch)"

# Function to get worktree info for interactive selection
get_worktree_list() {
  declare -a WORKTREES_DATA=()
  CURRENT_WT=""
  CURRENT_BRANCH_WT=""
  IS_MAIN_REPO=false
  
  while IFS= read -r line; do
    if [[ "${line}" =~ ^worktree\ (.+)$ ]]; then
      # Save previous worktree if it's not the main repo
      if [[ -n "${CURRENT_WT}" ]] && [[ "${IS_MAIN_REPO}" == false ]] && [[ "${CURRENT_WT}" != "${REPO_ROOT}" ]]; then
        WORKTREES_DATA+=("${CURRENT_WT}|${CURRENT_BRANCH_WT}")
      fi
      
      CURRENT_WT="${BASH_REMATCH[1]}"
      CURRENT_BRANCH_WT=""
      IS_MAIN_REPO=false
      
    elif [[ "${line}" =~ ^branch\ refs/heads/(.+)$ ]]; then
      CURRENT_BRANCH_WT="${BASH_REMATCH[1]}"
      
    elif [[ "${line}" =~ ^bare$ ]]; then
      IS_MAIN_REPO=true
    fi
  done < <(git worktree list --porcelain)
  
  # Save last worktree if it's not the main repo
  if [[ -n "${CURRENT_WT}" ]] && [[ "${IS_MAIN_REPO}" == false ]] && [[ "${CURRENT_WT}" != "${REPO_ROOT}" ]]; then
    WORKTREES_DATA+=("${CURRENT_WT}|${CURRENT_BRANCH_WT}")
  fi
  
  # Return the array
  printf '%s\n' "${WORKTREES_DATA[@]}"
}

# Function to find worktree by branch name or path
find_worktree() {
  local search="$1"
  local found_path=""
  local found_branch=""
  
  while IFS='|' read -r wt_path wt_branch; do
    # Match by branch name or path
    if [[ "${wt_branch}" == "${search}" ]] || [[ "${wt_path}" == "${search}" ]] || [[ "$(basename "${wt_path}")" == "${search}" ]]; then
      found_path="${wt_path}"
      found_branch="${wt_branch}"
      break
    fi
  done < <(get_worktree_list)
  
  if [[ -n "${found_path}" ]]; then
    echo "${found_path}|${found_branch}"
    return 0
  else
    return 1
  fi
}

# If no target specified, use interactive mode with fzf
if [[ -z "${TARGET}" ]]; then
  if ! command -v fzf >/dev/null 2>&1; then
    error "fzf is required for interactive mode"
    echo "Install fzf or specify a branch name/path directly" >&2
    exit 1
  fi
  
  # Get worktree list
  WORKTREE_LIST="$(get_worktree_list)"
  
  if [[ -z "${WORKTREE_LIST}" ]]; then
    echo "No worktrees found."
    exit 0
  fi
  
  # Format for fzf display
  FZF_INPUT=""
  while IFS='|' read -r wt_path wt_branch; do
    wt_name="$(basename "${wt_path}")"
    merge_status="[ACTIVE]"
    symbol="•"
    
    if is_branch_merged "${wt_branch}"; then
      merge_status="[MERGED]"
      symbol="✓"
    fi
    
    FZF_INPUT+="${symbol} ${wt_name}|${wt_branch}|${merge_status}|${wt_path}"$'\n'
  done <<< "${WORKTREE_LIST}"
  
  # Use fzf to select
  SELECTED=$(echo -n "${FZF_INPUT}" | fzf --ansi --header="Select worktree to remove:" --delimiter='|' --with-nth=1,2,3 --preview='echo "Path: {4}"')
  
  if [[ -z "${SELECTED}" ]]; then
    echo "No worktree selected."
    exit 0
  fi
  
  # Extract path from selection
  WORKTREE_PATH="$(echo "${SELECTED}" | cut -d'|' -f4)"
  BRANCH_NAME="$(echo "${SELECTED}" | cut -d'|' -f2)"
else
  # Find worktree by target
  if ! FOUND_INFO="$(find_worktree "${TARGET}")"; then
    error "Worktree not found: ${TARGET}"
    echo ""
    echo "Available worktrees:"
    while IFS='|' read -r wt_path wt_branch; do
      echo "  - ${wt_branch} ($(basename "${wt_path}"))"
    done < <(get_worktree_list)
    exit 1
  fi
  
  WORKTREE_PATH="${FOUND_INFO%%|*}"
  BRANCH_NAME="${FOUND_INFO##*|}"
fi

# Confirm removal unless force flag is set
if [[ "${FORCE}" != true ]]; then
  echo "Removing worktree:"
  echo "  Name: $(basename "${WORKTREE_PATH}")"
  echo "  Branch: ${BRANCH_NAME}"
  echo "  Path: ${WORKTREE_PATH}"
  echo ""
  
  # Check if branch is merged
  if is_branch_merged "${BRANCH_NAME}"; then
    echo -e "  Status: ${COLOR_GREEN}[MERGED into ${MAIN_BRANCH}]${COLOR_RESET}"
  else
    echo -e "  Status: ${COLOR_YELLOW}[NOT MERGED - may contain uncommitted work]${COLOR_RESET}"
  fi
  echo ""
  
  read -rp "Are you sure? [y/N]: " confirm
  if [[ ! "${confirm}" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
  fi
fi

# Remove the worktree
echo "Removing worktree..."
if git worktree remove "${WORKTREE_PATH}" 2>/dev/null; then
  success "✓ Worktree removed successfully"
else
  # Try force remove if it has modifications
  warning "Worktree has modifications, forcing removal..."
  if git worktree remove --force "${WORKTREE_PATH}"; then
    success "✓ Worktree force-removed successfully"
  else
    error "Failed to remove worktree"
    exit 1
  fi
fi

# Offer to delete the branch if it's merged
if [[ "${DELETE_BRANCH}" == true ]] && is_branch_merged "${BRANCH_NAME}"; then
  echo ""
  echo "Branch '${BRANCH_NAME}' is merged into ${MAIN_BRANCH}."
  
  if [[ "${FORCE}" != true ]]; then
    read -rp "Delete the branch? [y/N]: " delete_confirm
    if [[ ! "${delete_confirm}" =~ ^[Yy]$ ]]; then
      echo "Branch kept."
      exit 0
    fi
  fi
  
  echo "Deleting branch..."
  if git branch -d "${BRANCH_NAME}" 2>/dev/null; then
    success "✓ Branch deleted successfully"
  else
    warning "Failed to delete branch (it may still be in use)"
  fi
elif is_branch_merged "${BRANCH_NAME}" && [[ "${DELETE_BRANCH}" != true ]]; then
  echo ""
  info "Tip: Branch '${BRANCH_NAME}' is merged. Delete it with:"
  echo "  git branch -d ${BRANCH_NAME}"
  echo "  or use: git-wt-remove -d ${BRANCH_NAME}"
fi

#!/usr/bin/env bash

if [[ $# -eq 1 ]]; then
  selected=$1
else
  # Find git repos in projects/ folders
  projects=$(find ~/work/*/projects ~/personal/projects -name .git -maxdepth 2 -type d -prune -exec dirname {} \; 2>/dev/null)
  
  # Find worktrees and prefix with [WT]
  worktrees=$(find ~/work/*/worktrees ~/personal/worktrees -mindepth 1 -maxdepth 1 -type d 2>/dev/null | sed 's/^/[WT] /')
  
  # Combine both lists and use fzf
  selected=$(printf "%s\n%s" "$projects" "$worktrees" | fzf --preview 'tree -C $(echo {} | sed "s/^\[WT\] //") | head -200')
  
  # Remove [WT] prefix if present
  selected=$(echo "$selected" | sed 's/^\[WT\] //')
fi

if [[ -z $selected ]]; then
  exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
  tmux new-session -s $selected_name -c $selected
  exit 0
fi

if ! tmux has-session -t=$selected_name 2>/dev/null; then
  tmux new-session -ds $selected_name -c $selected
fi

tmux switch-client -t $selected_name
